---
name: Coverage Analysis

"on":
  push:
  pull_request:
  workflow_dispatch:

env:
  PYTHONUNBUFFERED: 1
  FORCE_COLOR: 1

jobs:
  coverage:
    name: Test Coverage Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"
          cache: "pip"

      - name: Install dependencies
        uses: ./.github/actions/setup-python-deps

      - name: Run comprehensive tests with coverage
        run: |
          echo "::group::Full Test Suite with Coverage"
          set +e

          # Use longer timeout for coverage analysis (Ubuntu tends to be slower)
          TIMEOUT=600

          PYTEST_CMD=(pytest \
            --cov=versiontracker \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            --cov-branch \
            --cov-fail-under=15 \
            --timeout=$TIMEOUT \
            --timeout-method=thread \
            --maxfail=10 \
            -v)
          "${PYTEST_CMD[@]}" 2>&1 | tee pytest_output.log
          EC=$?

          # Handle pytest KeyboardInterrupt (exit code 2)
          # This can happen when tests that validate KeyboardInterrupt handling run
          if [ "$EC" -eq 2 ]; then
            echo "âš ï¸ Detected pytest exit code 2 (KeyboardInterrupt)"
            # Check if tests actually passed by looking for the summary line
            if grep -q "passed" pytest_output.log && ! grep -q " FAILED " pytest_output.log; then
              echo "âœ… Tests passed despite KeyboardInterrupt exit code"
              echo "This is expected when testing KeyboardInterrupt handling"
              EC=0
            else
              echo "âŒ Retrying with doubled timeout..."
              TIMEOUT=$((TIMEOUT * 2))
              PYTEST_CMD=(pytest \
                --cov=versiontracker \
                --cov-report=xml \
                --cov-report=html \
                --cov-report=term-missing \
                --cov-branch \
                --cov-fail-under=15 \
                --timeout=$TIMEOUT \
                --timeout-method=thread \
                --maxfail=10 \
                -v)
              "${PYTEST_CMD[@]}"
              EC=$?
            fi
          fi
          echo "::endgroup::"
          exit $EC

      - name: Upload coverage to Codecov
        # Skip on PRs from forks where secrets are unavailable
        if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage.xml
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload coverage HTML report
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: coverage-html-report
          path: htmlcov/

      - name: Coverage summary
        run: |
          echo "## ðŸ“Š Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Coverage report uploaded to:" >> $GITHUB_STEP_SUMMARY
          echo "- [Codecov](https://codecov.io/gh/${{ github.repository }})" >> $GITHUB_STEP_SUMMARY
          echo "- HTML report in workflow artifacts" >> $GITHUB_STEP_SUMMARY
